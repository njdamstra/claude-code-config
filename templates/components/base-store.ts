import { z } from 'zod'
import { BaseStore } from '@/stores/BaseStore'
import type { Models } from 'appwrite'

/**
 * Store: [StoreName]Store
 *
 * Purpose: [Brief description of what this store manages]
 *
 * Usage:
 * ```typescript
 * import { exampleStore } from '@/stores/exampleStore'
 *
 * // Read data
 * const items = exampleStore.get()
 *
 * // Subscribe to changes
 * exampleStore.subscribe((items) => {
 *   console.log('Items updated:', items)
 * })
 *
 * // Modify data
 * await exampleStore.create({ name: 'New Item' })
 * await exampleStore.update('item-id', { name: 'Updated' })
 * await exampleStore.delete('item-id')
 * ```
 */

// ============================================================================
// Zod Schema (must match Appwrite collection attributes)
// ============================================================================

/**
 * Zod schema for [Entity] - MUST match Appwrite collection exactly
 *
 * Appwrite Collection: [COLLECTION_NAME]
 * Database: [DATABASE_NAME]
 */
export const ExampleSchema = z.object({
  /**
   * Document ID (auto-generated by Appwrite)
   */
  $id: z.string().optional(),

  /**
   * Example string field
   * Appwrite: string attribute, required
   */
  name: z.string().min(1, 'Name is required').max(100, 'Name too long'),

  /**
   * Example enum field
   * Appwrite: enum attribute with values
   */
  status: z.enum(['active', 'inactive', 'pending']).default('pending'),

  /**
   * Example optional field
   * Appwrite: string attribute, optional
   */
  description: z.string().max(500).optional(),

  /**
   * Example number field
   * Appwrite: integer attribute
   */
  count: z.number().int().min(0).default(0),

  /**
   * Example boolean field
   * Appwrite: boolean attribute
   */
  isPublic: z.boolean().default(false),

  /**
   * Example array field
   * Appwrite: string array attribute
   */
  tags: z.array(z.string()).default([]),

  /**
   * Example relationship field (document ID reference)
   * Appwrite: relationship to another collection
   */
  userId: z.string(),

  /**
   * Timestamps (auto-managed by Appwrite)
   */
  $createdAt: z.string().optional(),
  $updatedAt: z.string().optional(),
  $permissions: z.array(z.string()).optional(),
})

// ============================================================================
// TypeScript Types
// ============================================================================

/**
 * Type inferred from Zod schema
 */
export type Example = z.infer<typeof ExampleSchema>

/**
 * Type for creating new documents (omit auto-generated fields)
 */
export type ExampleCreate = Omit<
  Example,
  '$id' | '$createdAt' | '$updatedAt' | '$permissions'
>

/**
 * Type for updating documents (all fields optional except ID)
 */
export type ExampleUpdate = Partial<ExampleCreate>

/**
 * Appwrite document type (includes system fields)
 */
export type ExampleDocument = Example & Models.Document

// ============================================================================
// Store Configuration
// ============================================================================

const DATABASE_ID = import.meta.env.PUBLIC_APPWRITE_DATABASE_ID || 'main'
const COLLECTION_ID = 'examples' // Your Appwrite collection ID

// ============================================================================
// Store Instance
// ============================================================================

/**
 * Store instance for [Entity] collection
 * Extends BaseStore with type-safe CRUD operations and real-time updates
 */
class ExampleStore extends BaseStore<Example> {
  constructor() {
    super({
      databaseId: DATABASE_ID,
      collectionId: COLLECTION_ID,
      schema: ExampleSchema,
    })
  }

  // ============================================================================
  // Custom Methods (Optional)
  // ============================================================================

  /**
   * Example custom query method
   * Find all active items
   */
  async getActive(): Promise<Example[]> {
    const { documents } = await this.appwrite.database.listDocuments(
      this.databaseId,
      this.collectionId,
      [this.appwrite.Query.equal('status', 'active')]
    )

    return documents.map((doc) => this.parseDocument(doc))
  }

  /**
   * Example custom query method
   * Find items by user
   */
  async getByUserId(userId: string): Promise<Example[]> {
    const { documents } = await this.appwrite.database.listDocuments(
      this.databaseId,
      this.collectionId,
      [this.appwrite.Query.equal('userId', userId)]
    )

    return documents.map((doc) => this.parseDocument(doc))
  }

  /**
   * Example custom mutation method
   * Toggle item status
   */
  async toggleStatus(id: string): Promise<Example> {
    const current = this.getById(id)
    if (!current) {
      throw new Error(`Example with id ${id} not found`)
    }

    const newStatus = current.status === 'active' ? 'inactive' : 'active'
    return this.update(id, { status: newStatus })
  }

  /**
   * Example batch operation
   * Delete multiple items
   */
  async deleteByIds(ids: string[]): Promise<void> {
    await Promise.all(ids.map((id) => this.delete(id)))
  }
}

// ============================================================================
// Export Store Instance
// ============================================================================

/**
 * Singleton instance of ExampleStore
 * Import this in your components/composables
 */
export const exampleStore = new ExampleStore()

// ============================================================================
// Vue Integration Helper (Optional)
// ============================================================================

/**
 * Composable for using ExampleStore in Vue components
 * Provides reactive access to store state
 *
 * @example
 * ```vue
 * <script setup lang="ts">
 * import { useExampleStore } from '@/stores/exampleStore'
 *
 * const { items, isLoading, create, update, delete } = useExampleStore()
 * </script>
 * ```
 */
export function useExampleStore() {
  return {
    // Store instance
    store: exampleStore,

    // Reactive state (auto-updates from store)
    items: exampleStore.subscribe((items) => items),

    // Methods
    getById: (id: string) => exampleStore.getById(id),
    create: (data: ExampleCreate) => exampleStore.create(data),
    update: (id: string, data: ExampleUpdate) => exampleStore.update(id, data),
    delete: (id: string) => exampleStore.delete(id),

    // Custom methods
    getActive: () => exampleStore.getActive(),
    getByUserId: (userId: string) => exampleStore.getByUserId(userId),
    toggleStatus: (id: string) => exampleStore.toggleStatus(id),
  }
}

// ============================================================================
// Type Guards (Optional)
// ============================================================================

/**
 * Type guard to check if object is valid Example
 */
export function isExample(obj: unknown): obj is Example {
  return ExampleSchema.safeParse(obj).success
}

/**
 * Type guard to check if object is valid ExampleCreate
 */
export function isExampleCreate(obj: unknown): obj is ExampleCreate {
  const createSchema = ExampleSchema.omit({
    $id: true,
    $createdAt: true,
    $updatedAt: true,
    $permissions: true,
  })
  return createSchema.safeParse(obj).success
}
