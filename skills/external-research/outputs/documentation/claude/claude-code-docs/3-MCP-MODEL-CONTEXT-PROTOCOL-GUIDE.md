# Model Context Protocol (MCP): Comprehensive Reference Guide

**Author:** Verified from Anthropic Official Documentation + Community Best Practices  
**Last Updated:** October 2025  
**Status:** Single Source of Truth - Complete Technical Reference

---

## TABLE OF CONTENTS

1. [What Is MCP](#what-is-mcp)
2. [Architecture & Components](#architecture--components)
3. [File Locations & Configuration](#file-locations--configuration)
4. [MCP Configuration in Claude Code](#mcp-configuration-in-claude-code)
5. [Pre-Built MCP Servers](#pre-built-mcp-servers)
6. [Building Custom MCP Servers](#building-custom-mcp-servers)
7. [Transport Protocols](#transport-protocols)
8. [Security Considerations](#security-considerations)
9. [Real-World Integration Examples](#real-world-integration-examples)
10. [Troubleshooting & Edge Cases](#troubleshooting--edge-cases)

---

## WHAT IS MCP?

### Definition

MCP is an open protocol that standardizes how applications provide context to LLMs. Think of MCP like a USB-C port for AI applications. Just as USB-C provides a standardized way to connect your devices to various peripherals and accessories, MCP provides a standardized way to connect AI models.

### Core Problem Solved

**Before MCP**: Each data source (GitHub, Slack, databases) required custom integration code.  
**With MCP**: Single standardized protocol works with any tool or data source.

### Key Characteristics

- **Open Protocol**: Standardized interface (JSON-RPC 2.0 based)
- **Bidirectional**: Both AI→Tool and Tool→AI communication
- **Stateful**: Maintains connections between clients and servers
- **Secure**: Authentication, permission-based access
- **Composable**: Multiple servers work together

### MCP vs RAG vs Hooks

| Aspect | MCP | RAG | Hooks |
|--------|-----|-----|-------|
| Purpose | Access external tools/data | Retrieve documents | Enforce automation |
| When | Real-time data needed | Historical data search | Actions at lifecycle points |
| Latency | Live queries | Batch retrieval | Synchronous |
| Use Case | APIs, databases, services | Documentation, archives | Linting, testing, formatting |

---

## ARCHITECTURE & COMPONENTS

### MCP Ecosystem Architecture

```
Your Machine:
┌─────────────────────────────────────────────────┐
│ Claude Code / Claude Desktop / IDE              │
│ (MCP Host)                                       │
│                                                  │
│  ┌─────────────────────────────────────────┐   │
│  │ MCP Client 1 ↔ MCP Server 1 (GitHub)   │   │
│  ├─────────────────────────────────────────┤   │
│  │ MCP Client 2 ↔ MCP Server 2 (Slack)    │   │
│  ├─────────────────────────────────────────┤   │
│  │ MCP Client 3 ↔ MCP Server 3 (Database) │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘

Remote Systems:
┌─────────────┐  ┌──────────┐  ┌────────────┐
│ GitHub API  │  │ Slack    │  │ PostgreSQL │
└─────────────┘  └──────────┘  └────────────┘
```

### Core Components

| Component | Role | Location | Function |
|-----------|------|----------|----------|
| **Host** | Main application | Local | Initiates connections, enforces security |
| **MCP Client** | Connection manager | Inside Host | 1:1 stateful session with server |
| **MCP Server** | Tool/Data provider | Local or Remote | Exposes capabilities via MCP |
| **Tools** | API functions | Various | What MCP server can do |
| **Resources** | Data sources | Various | What MCP server can access |
| **Prompts** | Templates | Server side | Pre-defined request templates |

### Connection Flow

```
1. Host reads settings.json
   ↓
2. Host loads MCP server configuration
   ↓
3. Host spawns MCP client process for each server
   ↓
4. Client establishes connection to MCP server
   ↓
5. Server registers available tools & resources
   ↓
6. AI model receives tool list during context loading
   ↓
7. When AI needs external data:
   - Client formats request
   - Sends to server via protocol
   - Server executes action
   - Returns result to client
   - Client formats for AI context
```

---

## FILE LOCATIONS & CONFIGURATION

### Directory Structure (macOS)

```
Project Root:
.claude/
├── settings.json                    # MCP configuration
├── settings.local.json              # Local overrides (not committed)
└── .mcp.json                        # Generated by MCP integration

User Level:
~/.claude/
├── settings.json                    # User MCP config
└── .mcp.json                        # User-level MCP setup

Remote MCP Servers:
~/mcp-servers/                       # Custom servers you build
├── my-github-server/
├── my-slack-server/
└── my-custom-service/
```

### settings.json Hierarchy

```
Priority (highest to lowest):
1. .claude/settings.local.json    (Project local, not committed)
2. .claude/settings.json          (Project, committed to git)
3. ~/.claude/settings.json        (User level, all projects)
```

---

## MCP CONFIGURATION IN CLAUDE CODE

### Basic Configuration Structure

```json
{
  "mcpServers": {
    "github": {
      "command": "node",
      "args": ["/path/to/mcp-github-server.js"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    },
    "slack": {
      "command": "python3",
      "args": ["/path/to/mcp-slack-server.py"],
      "env": {
        "SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"
      }
    }
  }
}
```

### MCP Server Configuration Fields

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `command` | String | Yes | Executable to run | "node", "python3", "npx" |
| `args` | Array | Yes | Arguments to command | ["/path/to/server.js"] |
| `env` | Object | No | Environment variables | {"API_KEY": "${VAR}"} |
| `cwd` | String | No | Working directory | "/path/to/project" |
| `timeout` | Number | No | Connection timeout (ms) | 30000 |

### Environment Variable Syntax

```json
{
  "env": {
    "API_KEY": "${API_KEY}",           // From shell environment
    "DB_URL": "postgresql://localhost", // Literal value
    "PORT": "5000"                      // Can be string
  }
}
```

Reference shell variables with `${VARIABLE_NAME}` syntax.

### Full Configuration Example

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": [
        "-y",
        "@anthropic-ai/mcp-github-server",
        "--directory",
        "."
      ],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      },
      "timeout": 30000
    },
    "postgres": {
      "command": "python3",
      "args": [
        "-m",
        "mcp.server.postgres"
      ],
      "env": {
        "DATABASE_URL": "${DATABASE_URL}",
        "DEBUG": "false"
      }
    },
    "slack": {
      "command": "node",
      "args": [
        "./mcp-servers/slack-server.js"
      ],
      "env": {
        "SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"
      },
      "cwd": "${HOME}/mcp-servers"
    }
  }
}
```

### Loading MCP Servers

```bash
# Manually check loaded servers
/mcp status

# List all available tools from MCP servers
/mcp tools

# Debug MCP connection issues
claude --debug
# Look for: [MCP] Connected to server...
# Or: [MCP] Failed to connect to...
```

---

## PRE-BUILT MCP SERVERS

### Official Anthropic MCP Servers

| Server | Purpose | Data Source | Installation |
|--------|---------|-------------|--------------|
| GitHub | Code repositories | GitHub API | `npx @anthropic-ai/mcp-github-server` |
| Slack | Messages, channels | Slack API | `npx @anthropic-ai/mcp-slack-server` |
| Google Drive | Documents, spreadsheets | Google Drive API | `npx @anthropic-ai/mcp-google-drive-server` |
| PostgreSQL | Database queries | PostgreSQL | `npx @anthropic-ai/mcp-postgres-server` |
| Git | Version history | Local git repo | `npx @anthropic-ai/mcp-git-server` |
| Puppeteer | Web scraping | Browser automation | `npx @anthropic-ai/mcp-puppeteer-server` |

### Installation Pattern (GitHub Example)

**Step 1**: Install the MCP server package
```bash
npm install --save-dev @anthropic-ai/mcp-github-server
```

**Step 2**: Add to `.claude/settings.json`
```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-github-server"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}
```

**Step 3**: Set environment variable (macOS)
```bash
# Add to ~/.zshrc or ~/.bash_profile
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxx"

# Or set in settings.json with literal value (not recommended for secrets)
```

**Step 4**: Verify connection
```bash
/mcp status
# Should show: ✓ github (1 tool available)
```

### Popular Community MCP Servers

| Name | Purpose | GitHub |
|------|---------|--------|
| **Context7** | Live documentation injection | @upstash/context7-mcp |
| **Brave Search** | Web search results | Real-time web data |
| **Apify** | Web scraping automation | 5000+ actors available |
| **Discord** | Channel management, messages | Discord bot integration |
| **Perplexity** | AI-powered search | Cross-engine search |
| **AWS** | AWS resource management | AWS CLI wrapper |
| **GitLab** | GitLab repositories | Alternative to GitHub |

---

## BUILDING CUSTOM MCP SERVERS

### Architecture: Creating Your Own Server

Custom MCP servers use:
- **TypeScript or Python SDK**
- **Server process** that listens for JSON-RPC requests
- **Tools** that Claude can invoke
- **Resources** that Claude can read

### Minimal TypeScript Server

```typescript
// mcp-server-example.ts
import { Server } from "@anthropic-ai/mcp-sdk";

const server = new Server({
  name: "my-custom-server",
  version: "1.0.0"
});

// Define a tool
server.tool({
  name: "get_weather",
  description: "Get weather for a city",
  inputSchema: {
    type: "object",
    properties: {
      city: {
        type: "string",
        description: "City name"
      }
    },
    required: ["city"]
  },
  execute: async (input: { city: string }) => {
    const response = await fetch(
      `https://api.weather.com/forecast?city=${input.city}`
    );
    return response.json();
  }
});

// Define a resource
server.resource({
  uri: "file:///project/config",
  mimeType: "text/plain",
  read: async () => {
    return "config content here";
  }
});

server.start();
```

### Installation for Claude Code

**Step 1**: Save server file to project

```bash
mkdir -p ~/.mcp-servers
# or for project-specific:
mkdir -p .claude/mcp-servers
```

**Step 2**: Configure in settings.json

```json
{
  "mcpServers": {
    "my-custom": {
      "command": "node",
      "args": ["/path/to/mcp-server.js"]
    }
  }
}
```

**Step 3**: Test connection

```bash
/mcp status
# Should list your custom server
```

### Common Server Patterns

**Pattern 1: API Wrapper**
```typescript
server.tool({
  name: "api_call",
  execute: async (input) => {
    const response = await fetch(input.url);
    return response.json();
  }
});
```

**Pattern 2: Database Query**
```typescript
server.tool({
  name: "query_db",
  execute: async (input) => {
    const result = await db.query(input.sql);
    return result.rows;
  }
});
```

**Pattern 3: File Operations**
```typescript
server.resource({
  uri: "file:///workspace/docs",
  read: async () => {
    const fs = require("fs");
    return fs.readFileSync("/workspace/docs/README.md", "utf-8");
  }
});
```

---

## TRANSPORT PROTOCOLS

### Supported Transports

| Protocol | Use Case | Connection Type | Latency |
|----------|----------|-----------------|---------|
| **Stdio** | Local servers | Process pipes | Very low (~1-5ms) |
| **HTTP** | Remote servers | REST over HTTP | Low (~50-200ms) |
| **HTTP with SSE** | Streaming responses | Server-Sent Events | Variable |
| **WebSocket** | Bidirectional streaming | WebSocket | Low (~10-50ms) |

### Stdio Transport (Local Servers)

Best for your machine's local MCP servers.

```json
{
  "mcpServers": {
    "local-tool": {
      "command": "node",
      "args": ["./my-server.js"]
    }
  }
}
```

How it works:
- Claude Code spawns process
- Communicates via stdin/stdout
- Most efficient for local use

### HTTP Transport (Remote Servers)

For servers running on network/cloud.

```json
{
  "mcpServers": {
    "remote-api": {
      "command": "node",
      "args": ["-e", "require('@anthropic-ai/mcp-http-client')"],
      "env": {
        "MCP_URL": "https://mcp-server.example.com"
      }
    }
  }
}
```

---

## SECURITY CONSIDERATIONS

### ⚠️ CRITICAL SECURITY RULES

1. **API Keys in Environment Variables**
   ```bash
   # ✅ CORRECT
   export GITHUB_TOKEN="ghp_xxxxx"
   
   # ❌ WRONG
   # Never hardcode in settings.json (except for testing)
   ```

2. **Sensitive Data in MCP Servers**
   - MCP servers can access any data they're given
   - Restrict permissions at server initialization
   - Never pass secrets through tool outputs

3. **Network-Based MCP Servers**
   - Use HTTPS only for remote servers
   - Validate TLS certificates
   - Implement server-side authentication
   - Rate-limit tools to prevent abuse

### Best Practices

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["@anthropic-ai/mcp-github-server"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}",
        "ALLOWED_REPOS": "my-org/*"
      }
    }
  }
}
```

Include:
- Environment variable references (not literals)
- Scope restrictions (allowed repos, channels, etc.)
- Timeout settings (prevent hanging)
- Audit logging if possible

---

## REAL-WORLD INTEGRATION EXAMPLES

### Example 1: GitHub Integration

**Use Case**: Claude Code reads pull requests and suggests reviews

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-github-server"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}
```

**Usage in Claude Code**:
```bash
claude
# In Claude Code:
> Review the latest PR using the GitHub MCP

# Claude will:
# 1. Use GitHub tool to fetch PRs
# 2. Read changed files
# 3. Provide review comments
```

---

### Example 2: Database Integration

**Use Case**: Query PostgreSQL directly from Claude Code

```json
{
  "mcpServers": {
    "postgres": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-postgres-server"],
      "env": {
        "DATABASE_URL": "${DATABASE_URL}"
      }
    }
  }
}
```

**Example Query**:
```bash
claude
> What are the top 5 customers by revenue?

# Claude will:
# 1. Use postgres tool to write SQL
# 2. Execute query
# 3. Return results with analysis
```

---

### Example 3: Slack Integration

**Use Case**: Let Claude read Slack channels for context

```json
{
  "mcpServers": {
    "slack": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-slack-server"],
      "env": {
        "SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"
      }
    }
  }
}
```

---

### Example 4: Multi-Server Setup

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-github-server"],
      "env": {"GITHUB_TOKEN": "${GITHUB_TOKEN}"}
    },
    "slack": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-slack-server"],
      "env": {"SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"}
    },
    "postgres": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-postgres-server"],
      "env": {"DATABASE_URL": "${DATABASE_URL}"}
    }
  }
}
```

Claude can now:
- Fetch code from GitHub
- Check Slack for team context
- Query database for data
- All in single conversation

---

## TROUBLESHOOTING & EDGE CASES

### Q: MCP server not connecting

**A**: Check connection with `/mcp status`

```bash
/mcp status

# Output:
# ✓ github (connected)
# ✗ slack (failed to connect)
```

**Debug steps**:

1. Verify settings.json is valid JSON
2. Check if command exists: `which node`, `which python3`
3. Verify environment variables are set
4. Check server logs: `claude --debug`
5. Test command directly:
   ```bash
   node /path/to/server.js
   ```

---

### Q: Environment variable not being substituted

**A**: Use correct syntax: `${VARIABLE_NAME}`

```json
// ✅ CORRECT
"GITHUB_TOKEN": "${GITHUB_TOKEN}"

// ❌ WRONG
"GITHUB_TOKEN": "$GITHUB_TOKEN"
"GITHUB_TOKEN": "{GITHUB_TOKEN}"
```

Variable must be set in shell:
```bash
export GITHUB_TOKEN="value"
echo $GITHUB_TOKEN  # Verify it's set
```

---

### Q: MCP server crashes immediately

**A**: Server might be expecting stdin format.

```json
// Try with stdin option
{
  "mcpServers": {
    "server": {
      "command": "node",
      "args": ["server.js"],
      "stdin": true
    }
  }
}
```

Or check if server needs specific Node version:
```bash
node --version
# Some servers require Node 16+
```

---

### Q: Can I use MCP server with API that requires authentication?

**A**: Yes, pass credentials via environment variables

```json
{
  "mcpServers": {
    "custom-api": {
      "command": "node",
      "args": ["./custom-api-server.js"],
      "env": {
        "API_KEY": "${CUSTOM_API_KEY}",
        "API_SECRET": "${CUSTOM_API_SECRET}",
        "API_URL": "https://api.example.com"
      }
    }
  }
}
```

Never include secrets in settings.json:
```bash
# Set in shell
export CUSTOM_API_KEY="sk-..."
export CUSTOM_API_SECRET="secret-..."
```

---

### Q: Multiple MCP servers, one is slow - how to set timeout?

**A**: Configure timeout for slow server

```json
{
  "mcpServers": {
    "fast-server": {
      "command": "node",
      "args": ["fast.js"],
      "timeout": 5000
    },
    "slow-server": {
      "command": "node",
      "args": ["slow.js"],
      "timeout": 30000
    }
  }
}
```

Timeout in milliseconds. Default is usually 30000ms (30 seconds).

---

### Q: Can MCP servers talk to each other?

**A**: Not directly. They're isolated processes.

To connect them:
1. Create a wrapper MCP server that calls both
2. Or use hooks to orchestrate between them
3. Or have Claude Code handle the orchestration

---

### Q: How do I debug MCP server I'm building?

**A**: Add logging to your server

```typescript
import fs from "fs";

const log = (msg: string) => {
  fs.appendFileSync("/tmp/mcp-debug.log", `${new Date().toISOString()}: ${msg}\n`);
};

server.tool({
  name: "my_tool",
  execute: async (input) => {
    log(`Tool called with: ${JSON.stringify(input)}`);
    try {
      const result = await doSomething(input);
      log(`Tool returned: ${JSON.stringify(result)}`);
      return result;
    } catch (err) {
      log(`Tool error: ${err.message}`);
      throw err;
    }
  }
});
```

Then check logs:
```bash
tail -f /tmp/mcp-debug.log
```

---

### Q: Can I have different MCP servers for different projects?

**A**: Yes, use project-level configuration

```bash
project-a/
├── .claude/
│   └── settings.json    # Project A's MCP servers
└── README.md

project-b/
├── .claude/
│   └── settings.json    # Project B's MCP servers
└── README.md
```

Project settings override user-level settings.

---

### Q: MCP server consumes too much memory

**A**: Set resource limits or restart periodically

```json
{
  "mcpServers": {
    "memory-heavy": {
      "command": "node",
      "args": ["--max-old-space-size=512", "server.js"]
    }
  }
}
```

Or restart Claude Code session to clear MCP processes.

---

### Q: Can I use MCP with Claude in web chat?

**A**: Not yet. MCP is currently supported in:
- ✅ Claude Desktop app
- ✅ Claude Code CLI
- ✅ IDE integrations (VS Code, etc.)
- ❌ Web chat (claude.ai)

---

## QUICK REFERENCE CHECKLIST

- [ ] MCP server installed (`npm install` / `pip install`)
- [ ] Settings.json has correct `command` and `args`
- [ ] Environment variables set in shell (`export VAR=value`)
- [ ] Settings.json uses `${VARIABLE}` syntax for env vars
- [ ] No hardcoded secrets in settings.json
- [ ] `/mcp status` shows server connected
- [ ] Tested with Claude Code (`claude` command)
- [ ] Project-level settings committed to git
- [ ] User-level settings in `.gitignore`
- [ ] Custom MCP server tested standalone first

---

## RELATED RESOURCES

- Official MCP Documentation: https://docs.anthropic.com/en/docs/mcp
- MCP Servers Directory: https://claudemcp.com/
- Anthropic's MCP Announcement: https://www.anthropic.com/news/model-context-protocol
- Community MCP Servers: https://github.com/cnych/claude-mcp
- MCP SDK (TypeScript): @anthropic-ai/mcp-sdk
- MCP SDK (Python): mcp-server-python

---

## SUMMARY

**MCP = Standardized Way to Connect Claude to External Tools**

1. **Install**: Add pre-built server or build custom
2. **Configure**: Add to `.claude/settings.json`
3. **Secure**: Set API keys as environment variables
4. **Use**: Claude automatically discovers tools and resources
5. **Extend**: Multiple servers work together seamlessly
