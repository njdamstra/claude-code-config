name: refactoring-plan
description: Systematic code refactoring with safety validation and incremental approach
estimated_time: 20-60 minutes
estimated_tokens: 20K-80K
complexity: moderate

phases:
  - discovery
  - analysis
  - planning
  - synthesis
  - validation

subagent_matrix:
  discovery:
    always:
      - code-researcher
    conditional: {}

  analysis:
    always:
      - refactoring-analyzer
    conditional: {}

  planning:
    always:
      - refactoring-planner
    conditional: {}

  synthesis:
    always: []  # Main agent consolidates all findings

  validation:
    always:
      - safety-validator
      - scope-reviewer

subagent_outputs:
  discovery:
    code-researcher: codebase-analysis.json
  analysis:
    refactoring-analyzer: code-analysis.json
  planning:
    refactoring-planner: refactoring-sequence.md
  validation:
    safety-validator: safety-check.json
    scope-reviewer: scope-assessment.json

gap_checks:
  discovery:
    criteria:
      - "All target files identified"
      - "Dependencies mapped completely"
      - "Impact scope is clear"
    on_failure:
      - "Retry discovery with broader scope"
      - "Continue with gaps noted"
      - "Abort workflow"

  analysis:
    criteria:
      - "Code smells are categorized by severity"
      - "Duplications have consolidation targets"
      - "Complexity metrics baseline established"
    on_failure:
      - "Retry analysis with deeper inspection"
      - "Continue with warnings"
      - "Abort workflow"

  planning:
    criteria:
      - "Refactoring steps are incremental"
      - "Each step has rollback plan"
      - "Test coverage is adequate"
      - "Risks are identified and mitigated"
    on_failure:
      - "Retry planning phase"
      - "Continue with warnings"
      - "Abort workflow"

checkpoints:
  - after: analysis
    prompt: "Review code analysis before planning refactoring approach"
    show_files:
      - "{{output_dir}}/phase-analysis/code-smells.json"
      - "{{output_dir}}/phase-analysis/duplications.json"
      - "{{output_dir}}/phase-analysis/complexity.json"
    options:
      - "Continue to planning"
      - "Repeat analysis with different focus"
      - "Abort"

  - after: validation
    prompt: "Review refactoring plan before implementation"
    show_files:
      - "{{output_dir}}/phase-planning/refactoring-sequence.md"
      - "{{output_dir}}/phase-validation/safety.json"
      - "{{output_dir}}/phase-validation/completeness.json"
    options:
      - "Finalize plan"
      - "Revise planning"
      - "Abort"

template: templates/refactoring-plan.md.tmpl
